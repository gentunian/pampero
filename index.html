<!DOCTYPE html>
	<html>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<head>
		
	

		<style>

		body, html {
			/*
			font-size: 12px;
			font-family: "Verdana";
			*/
			height: 100%;
		}
		.errorDetails {
			background-color: red;
			color: white;
			border: 1px solid;
			border-color: black;
		}
		.okDetails {
			background-color: green;
			color: white;
			border: 1px solid;
			border-color: black;
		}
		#table_id tbody > tr > td { 
			white-space: nowrap;
			text-overflow: ellipsis;
			overflow: hidden;
		}
		</style>
		<link type="text/css" rel="stylesheet" href="css/dialog.css">
		<link rel="stylesheet" href="css/bootstrap.min.css">
		<link rel="stylesheet" href="css/DT_bootstrap.css">
		<link rel="stylesheet" href="css/bootstrap-glyphicons.css">

		<script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/jquery.dataTables.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/TableTools.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/ZeroClipboard.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/jquery-ui-1.10.3.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/dialog.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/bootstrap.min.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/DT_bootstrap.js"></script>

		<script>
		(function() {
			var method;
			var noop = function () {};
			var methods = [
			'assert', 'clear', 'count', 'debug', 'dir', 'dirxml', 'error',
			'exception', 'group', 'groupCollapsed', 'groupEnd', 'info', 'log',
			'markTimeline', 'profile', 'profileEnd', 'table', 'time', 'timeEnd',
			'timeStamp', 'trace', 'warn'
			];
			var length = methods.length;
			var console = (window.console = window.console || {});

			while (length--) {
				method = methods[length];

				if (!console[method]) {
					console[method] = noop;
				}
			}
		}());

		// Tries to autodetect  operating system.
		function autoDetectOS() {
			var OSName="Unknown OS";
			if ( navigator.appVersion.indexOf( "Win" )!=-1 ) OSName="Windows";
			if ( navigator.appVersion.indexOf( "Mac" )!=-1 ) OSName="MacOS";
			if ( navigator.appVersion.indexOf( "X11" )!=-1 ) OSName="UNIX";
			if ( navigator.appVersion.indexOf( "Linux" )!=-1 ) OSName="Linux";
			return OSName;
		}

		// The table used to show available programs
		//var fTable;

		// The table used to report installation. This table will be embedded in the progress dialog
		//var reportTable;

		// A dialog to display installation progress
		var dialog;
		var lastProcessed;

		// progressImages will contain image resources representing the state the index describes
		// * 'install_busy' index will represent a progress image that denotes installing state.
		// * 'install_ok' index will represent a progress image that denotes OK state.
		// * 'install_error' index will represent a progress image that denotes ERROR state.
		var progressImages = [];
		progressImages[ 'install_busy' ] = "images/loading.gif";
		progressImages[ 'install_ok' ] = "images/ok.png";
		progressImages[ 'install_error' ] = "images/error.png";

		// Returns a pair of (rows, url) where 'rows' is an array of rowData
		// and 'url' is the url to send to the server with selected data
		function getSelectedRows( id ) {
			var trs = getSelectedTRs( id );
			var rows = [];
			var url = "";
			for( var i = 0; i < trs.length; i++ ) {
				var rowData = $( '#table_id' ).dataTable().fnGetData( trs[i] );
				url += "id[]=" + rowData.id + "&";
				rows.push(rowData);
			}
			return { data: rows, url: url};
		}

		// Returns <tr> elements that are selected
		function getSelectedTRs( id ) {
			return $( id+" .row_selected1");
		}

		function getDetailsHTMLTable( errorCode, statusMessage ) {
			var table = '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:1px;">';
			table += '<tr><td><b>'+statusMessage+' ['+errorCode+']</b></td></tr>';
			table += '</table>';
			return table;
		}

		// DOM ready function
		$( document ).ready( function() {
			$( '#auto' ).click( function ( e ){
				
				// If we clicked the anchor and it had 'glyphicon-ok' class,
				// then te current state is unchecked.
				var unchecked = $( 'div>span.glyphicon', this ).hasClass( "glyphicon-ok" );
				if ( !unchecked ) {
					$( 'div>span.glyphicon', this ).removeClass( "glyphicon-remove" );
					$( 'div>span.glyphicon', this ).addClass( "glyphicon-ok" );
					<?php
					require_once('admin/config.php');
					global $os, $arch;
					$hostname = gethostbyaddr($_SERVER['REMOTE_ADDR']);
					$machine = new Machine($hostname);
					if ($machine != NULL) {
						$os = $machine->getSystemInfo()->getOSName();
						$arch = $machine->getSystemInfo()->getOSArchitecture();
					} else {
						$os = OS_UNKNOWN;
						$arch = OS_UNKNOWN;
					}
					?>
					$( '#OSSelect' ).html( "<?php echo htmlentities($os); ?>" );
					$( '#archSelect' ).html( "<?php echo htmlentities($arch); ?> ");
					$( '#OSSelect' ).attr( "disabled", "disabled" );
					$( '#archSelect' ).attr( "disabled", "disabled" );
				} else {
					$( 'div>span.glyphicon', this ).removeClass( "glyphicon-ok" );
					$( 'div>span.glyphicon', this ).addClass( "glyphicon-remove" );
					$( '#OSSelect' ).removeAttr( "disabled" );
					$( '#archSelect' ).removeAttr( "disabled" )
					$( '#OSSelect' ).html( "Seleccione.. <span class='caret'/>" );
					$( '#archSelect' ).html( "Seleccione.. <span class='caret'/>" );
					$( '.dropdown-menu li').click( function ( e ) {
						var value = $(this).text();
						var group = $(this).parents('.btn-group');
						$( 'button', group ).html(value+" <span class='caret'/>");
					});
				}
			});
			$( '#auto' ).attr( "checked", "checked" );
			$( '#auto' ).click();

			// Creates the DataTable
			var table = $( '#table_id' ).dataTable({
				"sDom": "<'row'r>Tt<'row'<'col-lg-6'p>>",
				"sPaginationType": "bootstrap",
				"oTableTools": {
					"sRowSelect": "multi",
					"aButtons": "",
					"fnRowSelected": function( nodes ) {
						$( '#install' ).removeAttr( 'disabled' );
						$( 'tr.active span').addClass( 'glyphicon-ok' );
					},
					"fnRowDeselected": function( nodes ) {
						if (TableTools.fnGetInstance( 'table_id' ).fnGetSelected().length == 0) {
							$( '#install' ).attr( 'disabled', 'disabled' );
						}
						
					},
					"fnPreRowSelect": function( e, nodes ) {
						$( 'span',e.currentTarget ).removeClass( 'glyphicon-ok' );
						return true;
					},
					"sSelectedClass": "active"
				},
				"fnServerData": function ( sSource, aoData, fnCallback ) {
					$.getJSON( sSource, aoData, function ( json ) { 
						fnCallback({ "aaData": json });
					}).complete( function(){
						var table = $( '#table_id' ).dataTable();
						$( table.fnGetNodes() ).children( 'td.description_tooltip' ).popover({
							container: "body",
							animated: true,
							title: "Descripción",
							content: $(this).text,
							placement: "bottom",
							trigger: "hover"
						});
					});
				},
				"bAutoWidth": true,
				"bProcessing": true,
				"sAjaxSource": "php/packages.php?command=list&target",
				"aoColumns": [
				{ "mData": "id", "bVisible": false },
				{ 
					"mData":"name",
					"mRender": function( data, type, full ) {
						return '<span class="glyphicon">  '+data+'</span>';
					},
					"sTitle": "Nombre",
					"sClass": "left"
				},
				{ "mData": "os","sTitle": "Sistema Operativo", "sClass": "center" },
				{ "mData": "arch", "sTitle": "Arquitectura", "sClass": "center"	},
				{ "mData": "version", "sTitle": "Version", "sClass": "center" },
				{ 
					"mData": "description",
					"sTitle": "Descripción",
					"sClass": "left description_tooltip"
				}
				]
			});

	        // Creates a dialog to show installation progress
	        dialog = Dialog.createProgressDialog(
	        	"#dialog-box",
	        	{ 
	        		title: "Diálogo de progreso",
	        		message: "ATENCION: No apague el equipo ni recargue la página. "
	        		+ "Se está realizando la instalación de los paquetes seleccionados. "
	        		+ "Aguarde a que termine la instalación.",
	        		closeText: "Cerrar",
	        		ajaxSettings: {
	        			type: 'GET',
	        			dataType: 'json',
	        			url: '../php/packages.php?command=poll&target=' + $( '#hostname' ).text(),
	        			cache: false,
	        			success: function( data, status, jqXHR ) {
	        			    // Grabs the data for this host
	        				var data = data[$( '#hostname' ).text()];

	        				// Sets the value for the progress dialog
	        				dialog.setValue( data.processed );

	        				// If installation process has finished, inform and stop polling.
	        				// Else, set the current info and continue polling
	        				if ( data.status == "DONE" ) {
	        					// Sets the title
	        					dialog.setTitle( "Instalación Completada \t("+data.processed+"/"+data.toInstall+")" );

	        					// Stops polling server
	        					dialog.stopProgressQuery();

	        					// A generic message explaining whats going on...
	        					var message = "El proceso de instalación terminó";

	        					// Program to default. If an error was found, "error_state"
	        					// will be used instead.
	        					var state = "ok_state";
	        					if ( data.errors > 0 ) {
	        						message += " con <span style='color:red; font-weight: bold;'>errores</span>. Verifique los errores seleccionando las filas de abajo"
	        						+ " y solicite asistencia al administrador de sistemas";
	        						state =  "error_state";
	        					}

	        					// Sets the state
	        					dialog.setState( state );

	        					// Sets the message
	        					dialog.setMessage( message + "." );
	        				} else {
	        					dialog.setTitle( "Instalando " + data.current + " \t("+data.processed+"/"+data.toInstall+")" );
	        				}

	        				// Updates installed/processed packages visual information providing the adequate image.
	        				// In order to optimize we keep track of the last installed/processed package by using
	        				// a (sigh) global variable.
	        				for ( var i = lastProcessed; i < data.processed; i++ ) {
	        					var id = data.installData[i].id;
	        					var icon = document.getElementById(id);
	        					icon.src = ( data.installData[i].exitCode == 0 )? progressImages['install_ok'] : progressImages['install_error'];
	        					icon.alt = data.installData[i].exitCode + "," + data.installData[i].exitString;
	        				}

	        				// Sets the last processed package index
	        				lastProcessed = data.processed;
	        			},
	        			error: function( jq, status, er){
	        				console.log(status);
	        			}
	        		}
	        	});

	        // Sets the content for the dialog
	        dialog.setContent('<br/><table id="dialog-table" cellpadding="0" border="0" cellspacing="0" class="table table-striped table-bordered"></table>');

	        // Creates the datatable
	        $( '#dialog-table' ).dataTable({
	        	"sDom": '<"H"Tfr>',
				"oTableTools": {
					"sRowSelect": "multi",
					"aButtons": []
				},
				"bJQueryUI": true,
				"bSort": false,
				"bPaginate": false,
				"bFilter": false,
				"bInfo": false,
				"sScrollY": "150px",
				"bDeferRender": true,
				"bAutoWidth": false,
				"aoColumns": [
				{ "sTitle": "Aplicacion" },
				{
					"mRender": function(  data, type, full ) {
						return '<img id="'+full[0]+'" name="'+full[0]+'" width="24" height="24"  src="'+data+'"/>';
					},
					"sTitle": "Instalado",
					"sWidth": "24px",
					"sClass": "center"
				}
				]
			});

            // Adds a click handler for dialog table rows
	        $( '#dialog-table tbody' ).delegate( 'tr', 'click', function(){
	        	// Retrieves the icon img
	        	var img = $( 'td img', this );

	        	// Retrieves the dialog-table datatable reference
	        	var table = $( '#dialog-table' ).dataTable();

	        	// If the row is open, close it.
	        	if ( table.fnIsOpen( this )) {
	        		table.fnClose( this );
	        	} else {
	        		// If no 'alt' property was set for img, do nothing;
	        		if ( typeof( img.attr('alt') ) === "undefined") return;

	        		// Gets the 'alt' property and split it with ','
	        		var message = img.attr( 'alt' ).split( ',' );
	        		console.log(img.attr('alt'));
	        		var cls = 'errorDetails';
	        		if ( message[0] == '0' ) cls = 'okDetails';

	        		table.fnOpen( this, getDetailsHTMLTable( message[0], message[1] ), cls );
	        	}
			});

            // Binds the submit button
			$( '#form' ).submit( function() {
				// Gets selected data
				var rows = getSelectedRows( "#table_id" );
				dialog.max = rows.data.length;

				// Clears the dialog table
				$('#dialog-table').dataTable().fnClearTable();

				// Loads dialog table with data
				for(var i = 0; i < rows.data.length; i++) {
					$('#dialog-table').dataTable().fnAddData( [rows.data[i].id, progressImages['install_busy']] );
				}

				// Gets the query URL
				var url = "php/packages.php?command=install&target=" + $( '#hostname' ).text() + "&" + rows.url;
				console.log($('#hostname'));
				// Builds an AJAX request
				$.ajax({
					type: 'POST',
					cache: false,
					url: url,
					beforeSend: function( jqXHR, settings ) {
						lastProcessed = 0;
						dialog.startProgressQuery();
						dialog.setTitle( "Comenzando la Instalación" );
						dialog.show();
					},
					success: function( data, status, jqXHR) {
						console.log("success: ");
						//console.log(data);
						//dialog.stopProgressQuery();
					},
					error: function( jq, status, er ) {
						console.log("error: "+status+" - "+er);
					},
				});
				return false;
			} );  
		})
		</script>
	</head>
	<body>
		<?php
		$hostname = gethostbyaddr($_SERVER['REMOTE_ADDR']);
		echo '<div id="hostname" style="display:none;">' . $hostname . '</div>';
		?>
		<div id="myModal" class="modal fade">
			<div  class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title">Comenzando instalación</h4>
					</div>
					<div class="modal-body">
						<p>One fine body&hellip;</p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
						<button type="button" class="btn btn-primary">Save changes</button>
					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->

		<div class="container">
			<div class="row">
				<div class="col-lg-4">
					<div class="list-group">
						<a href="#" class="list-group-item active">
							<h4 class="panel-title" data-toggle="collapse" data-target="#demo">
								<span class="glyphicon glyphicon-info-sign"> Información de su Sistema</span>
								<span class="glyphicon glyphicon-chevron-up pull-right"></span>
							</h4>
							<p id="demo" class="list-group-item-text collapse" data-toggle="collapse" data-target="#demo">Puede evitar la autodetección destildando la opción <i>Usar Autodetección</i>.</p>
						</a>
						<a href="#" class="list-group-item" style="padding-right:10px; color:black;">
							Sistema Operativo
							<div class="btn-group pull-right">
								<button id="OSSelect" type="button"  disabled="disabled" class="btn btn-mini btn-info dropdown-toggle" data-toggle="dropdown">
								</button>
								<ul id="OSOptions" class="dropdown-menu">
								</ul>
							</div>
						</a>
						<a href="#" class="list-group-item" style="padding-right:10px; color:black;">
							Arquitectura
							<div class="btn-group pull-right">
								<button id="archSelect" type="button" disabled="disabled" class="btn btn-mini btn-info dropdown-toggle" data-toggle="dropdown">
								</button>
								<ul id="archOptions" class="dropdown-menu">
									<li class="text-center">x86_64</li>
									<li class="text-center">i686</li>
								</ul>
							</div>
						</a>
						<a id="auto" href="#" class="list-group-item" style="padding-right:10px; color:black;">
							<!--<input id="auto" name="auto" type="checkbox"><span> Usar Autodetección</span>-->
							<span>Usar autodetección</span>
							<div class="btn-group pull-right">
								<span class="glyphicon"></span>
							</div>
						</a>
					</div>
				</div>
				<div class="col-lg-8">
					<div class="panel panel-primary">
						<div class="panel-heading">
							<h4 class="panel-title" >
								<span class="glyphicon glyphicon-list-alt"> Grupos</span>
								<span class="glyphicon glyphicon-chevron-up pull-right"></span>
							</h4>
						</div>
						<span class="glyphicon glyphicon-warning-sign"> Aún no hay grupos disponibles para instalar.</span>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-12">
					<div class="panel panel-primary">
						<div class="panel-heading">
							<h4 class="panel-title" style="height:100%;" >
								<span class="glyphicon glyphicon-list"> Programas disponibles</span>
								<span class="glyphicon glyphicon-chevron-up pull-right"></span>
							</h4>
						</div>
						<form id="form">
							<table id="table_id" class="table table-striped table-bordered" style="table-layout:fixed"></table>
						</form>
						<div class="panel-footer">
							<span class="glyphicon glyphicon-info-sign"> Seleccione los programas que desea instalar y haga click en <i>Instalar</i></span>
							<button id="install" class="btn btn-mini btn-default pull-right" disabled data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-download-alt"></span>
								Instalar
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
	</html>