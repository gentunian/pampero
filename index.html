<!DOCTYPE html>
	<html>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<head>
		<style>
		body, html {
			/*
			font-size: 12px;
			font-family: "Verdana";
			*/
			height: 100%;
		}
		ul.dropdown-menu > li:hover {

			color: #ffffff;
			text-decoration: none;
			background-color: #357ebd;
			background-image: -webkit-gradient(linear, left 0%, left 100%, from(#428bca), to(#357ebd));
			background-image: -webkit-linear-gradient(top, #428bca, 0%, #357ebd, 100%);
			background-image: -moz-linear-gradient(top, #428bca 0%, #357ebd 100%);
			background-image: linear-gradient(to bottom, #428bca 0%, #357ebd 100%);
			background-repeat: repeat-x;
			filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ff428bca', endColorstr='#ff357ebd', GradientType=0);
		}
		ul.dropdown-menu > li {
			padding: 5px;
		}
		#table_id tbody > tr > td { 
			white-space: nowrap;
			text-overflow: ellipsis;
			overflow: hidden;
		}
		</style>

		<link rel="stylesheet" href="css/bootstrap.css">
		<link rel="stylesheet" href="css/DT_bootstrap.css">
		<link rel="stylesheet" href="css/bootstrap-glyphicons.css">

		<script type="text/javascript" charset="utf-8" src="js/jquery-dev.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/jquery.dataTables.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/TableTools.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/ZeroClipboard.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/jquery-ui-1.10.3.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/dialog.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/bootstrap.min.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/DT_bootstrap.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/dataTables.reloadAjax.plugin.js"></script>
		<script>
		(function() {
			var method;
			var noop = function () {};
			var methods = [
			'assert', 'clear', 'count', 'debug', 'dir', 'dirxml', 'error',
			'exception', 'group', 'groupCollapsed', 'groupEnd', 'info', 'log',
			'markTimeline', 'profile', 'profileEnd', 'table', 'time', 'timeEnd',
			'timeStamp', 'trace', 'warn'
			];
			var length = methods.length;
			var console = (window.console = window.console || {});

			while (length--) {
				method = methods[length];

				if (!console[method]) {
					console[method] = noop;
				}
			}
		}());

		// Tries to autodetect  operating system.
		function autoDetectOS() {
			var OSName="Unknown OS";
			if ( navigator.appVersion.indexOf( "Win" )!=-1 ) OSName="Windows";
			if ( navigator.appVersion.indexOf( "Mac" )!=-1 ) OSName="MacOS";
			if ( navigator.appVersion.indexOf( "X11" )!=-1 ) OSName="UNIX";
			if ( navigator.appVersion.indexOf( "Linux" )!=-1 ) OSName="Linux";
			return OSName;
		}

		// Returns a pair of (rows, url) where 'rows' is an array of rowData
		// and 'url' is the url to send to the server with selected data
		function getSelectedRows( id ) {
			var trs = getSelectedTRs( id );
			var rows = [];
			var url = "";
			for( var i = 0; i < trs.length; i++ ) {
				var rowData = $( '#table_id' ).dataTable().fnGetData( trs[i] );
				url += "id[]=" + rowData.id + "&";
				rows.push(rowData);
			}
			return { data: rows, url: url};
		}

		// Returns <tr> elements that are selected
		function getSelectedTRs( id ) {
			return $( id+" .active");
		}

		function loadDataFromUserSelection() {
			var os = $( '#OSButton>#value' ).text();
			var arch =  $( '#archButton>#value' ).text();
			var url = "php/packages.php?command=list&os=" + os + "&arch=" + arch;
			$( '#table_id' ).dataTable().fnReloadAjax( url );
		}

		function toProgressDialog() {
			return "ProgressDialog.html?d=" + Date().value;
		}

		// DOM ready function
		$( document ).ready( function() {
			$( '#auto' ).click( function ( e ){
				// If we clicked the anchor and it had 'glyphicon-ok' class,
				// then te current state is unchecked.
				var unchecked = $( 'div>span.glyphicon', this ).hasClass( "glyphicon-ok" );
				if ( !unchecked ) {
					$( 'div>span.glyphicon', this ).removeClass( "glyphicon-remove" );
					$( 'div>span.glyphicon', this ).addClass( "glyphicon-ok" );

					<?php /* --- PHP code --- */
 					require_once('admin/config.php');
					global $os, $arch;
					$hostname = gethostbyaddr($_SERVER['REMOTE_ADDR']);
					$machine = new Machine($hostname);
					if ($machine != NULL) {
						$os = $machine->getSystemInfo()->getOSName();
						$arch = $machine->getSystemInfo()->getOSArchitecture();
					} else {
						$os = OS_UNKNOWN;
						$arch = OS_UNKNOWN;
					}
					?>/* -- End PHP code --- */

					$( '#OSButton' ).html( "<?php echo htmlentities($os); ?>" );
					$( '#archButton' ).html( "<?php echo htmlentities($arch); ?> ");
					$( '#OSButton' ).attr( "disabled", "disabled" );
					$( '#archButton' ).attr( "disabled", "disabled" );
					$( '#table_id' ).dataTable().fnReloadAjax( 'php/packages.php?command=list&target=' + $( '#hostname' ).text() );
				} else {
					$( 'div>span.glyphicon', this ).removeClass( "glyphicon-ok" );
					$( 'div>span.glyphicon', this ).addClass( "glyphicon-remove" );

					var osButton = $( '#OSButton' );
					osButton.removeAttr( "disabled" );
					osButton.html( "Seleccione.. <span class='caret'/>" );
					osButton.trigger( "change" );

					var archButton = $( '#archButton' );
					archButton.removeAttr( "disabled" )
					archButton.html( "Seleccione.. <span class='caret'/>" );
					archButton.trigger( "change" );

					$( '.dropdown-menu li').click( function ( e ) {
						var value = $(this).text();
						var group = $(this).parents( '.btn-group' );
						var button = $( 'button', group );
						button.html( "<span id='value'>" + value + "</span><span class='caret'/>" );
						button.trigger("change");
					});
				}
			});

	        // Sets the checked attribute to 'checked' to simulate a checkbox 
	        $( '#auto' ).attr( "checked", "checked" );

	        // change event will be triggered from li.click() and from #auto.click() event.
	        // This is the only "cleaner" way to react on change event from a <span> element
	        $( '#OSButton' ).on('change', loadDataFromUserSelection );
	        $( '#archButton' ).on('change', loadDataFromUserSelection );

			// Creates the DataTable with the initial url
			/*
			var url = "php/packages.php?command=list&"
			+ "target=" + $( '#hostname' ).text()
			+ "&arch=" + $( '#archButton' ).text()
			+ "&os=" + $( '#OSButton' ).text();
			*/
			var table = $( '#table_id' ).dataTable({
				"sDom": "<'row'<'col-lg-6'T><'col-lg-6'f>r>t<'row-fluid'<'span6'><'span6'p>>",
				"oLanguage": {
					"sLoadingRecords": "Cargando -- Por favor espere...",
					"sProcessing": "Procesando...",
					"sZeroRecords": "No hay registros.",
					"sSearch": "",
					"oPaginate": {
						"sPrevious": "Anterior",
						"sNext": "Siguiente",
						"sLast": "Último",
						"sFirst": "Primero"
					}
				},
				"sPaginationType": "bootstrap",
				"oTableTools": {
					"sRowSelect": "multi",
					"aButtons": [
					{
						"sExtends": "select_all",
						"sButtonText": "Todo"
					},
					{
						"sExtends": "select_none",
						"sButtonText": "Ninguno"
					}
					],
					"fnRowSelected": function( nodes ) {
						$( '#install' ).removeAttr( 'disabled' );
						$( 'span', nodes ).addClass( 'glyphicon-ok' )
					},
					"fnRowDeselected": function( nodes ) {
						if (TableTools.fnGetInstance( 'table_id' ).fnGetSelected().length == 0) {
							$( '#install' ).attr( 'disabled', 'disabled' );
						}
						$( 'span', nodes ).removeClass( 'glyphicon-ok' )
					},
					"sSelectedClass": "active"
				},
				"fnServerData": function ( sSource, aoData, fnCallback ) {
					$.getJSON( sSource, aoData, function ( json ) { 
						fnCallback({ "aaData": json });
					}).complete( function(){
						var table = $( '#table_id' ).dataTable();
						$( table.fnGetNodes() ).children( 'td.description_tooltip' ).tooltip({
							container: "table",
							animated: true,
							title: $(this).text,
							placement: "bottom",
							trigger: "hover"
						});
					});
				},
				"bAutoWidth": true,
				"bProcessing": true,
//				"sAjaxSource": url,
				"aoColumns": [
				{ "mData": "id", "bVisible": false },
				{ 
					"mData":"name",
					"mRender": function( data, type, full ) {
						return '<span class="glyphicon">  '+data+'</span>';
					},
					"sTitle": "Nombre",
					"sClass": "left"
				},
				{ "mData": "os","sTitle": "Sistema Operativo", "sClass": "center" },
				{ "mData": "arch", "sTitle": "Arquitectura", "sClass": "center"	},
				{ "mData": "version", "sTitle": "Version", "sClass": "center" },
				{ 
					"mData": "description",
					"sTitle": "Descripción",
					"sClass": "left description_tooltip"
				}
				]
			});
	        var searchLabel = $( '#table_id_filter label' );
	        var searchField = searchLabel.children( 'input' );
	        searchLabel.addClass( 'input-group' );
	        searchField.addClass( 'form-control input-sm' );
	        searchField.attr( 'placeholder', 'Buscar...' );
	        $( '#auto' ).click();
		})
		</script>
	</head>
	<body>
		<?php
		$hostname = gethostbyaddr($_SERVER['REMOTE_ADDR']);
		echo '<div id="hostname" style="display:none;">' . $hostname . '</div>';
		?>
		<div id="myModal" data-backdrop="static" data-keyboard="false" class="modal fade">
			<div  class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title">Comenzando instalación</h4>
					</div>
					<div class="modal-body">
						<p>One fine body&hellip;</p>
					</div>
					<div class="modal-footer">
						<button id="close-dialog-button" type="button" class="btn btn-default" disabled data-dismiss="modal">Cerrar</button>
					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->

		<div class="container">
			<div class="row">
				<div class="col-lg-4">
					<div class="list-group">
						<a href="#" class="list-group-item active">
							<h4 class="panel-title" data-toggle="collapse" data-target="#demo">
								<span class="glyphicon glyphicon-info-sign"> Información de su Sistema</span>
								<span class="glyphicon glyphicon-chevron-up pull-right"></span>
							</h4>
							<p id="demo" class="list-group-item-text collapse" data-toggle="collapse" data-target="#demo">Puede evitar la autodetección destildando la opción <i>Usar Autodetección</i>.</p>
						</a>
						<a href="#" class="list-group-item" style="padding-right:10px; color:black;">
							Sistema Operativo
							<div class="btn-group pull-right">
								<button id="OSButton" disabled class="btn btn-mini btn-info dropdown-toggle" data-toggle="dropdown"></button>
								<ul id="OSOptions" class="dropdown-menu">
									<li class="divider"></li>
									<li class="text-center">asdf4</li>
								</ul>
							</div>
						</a>
						<a href="#" class="list-group-item" style="padding-right:10px; color:black;">
							Arquitectura
							<div class="btn-group pull-right">
								<button id="archButton" type="button" disabled="disabled" class="btn btn-mini btn-info dropdown-toggle" data-toggle="dropdown">
								</button>
								<ul id="archOptions" class="dropdown-menu">
									<li class="divider"></li>
									<li class="text-center">x86_64</li>
									<li class="text-center">i686</li>
								</ul>
							</div>
						</a>
						<a id="auto" href="#" class="list-group-item" style="padding-right:10px; color:black;">
							<!--<input id="auto" name="auto" type="checkbox"><span> Usar Autodetección</span>-->
							<span>Usar autodetección</span>
							<div class="btn-group pull-right">
								<span class="glyphicon"></span>
							</div>
						</a>
					</div>
				</div>
				<div class="col-lg-8">
					<div class="panel panel-primary">
						<div class="panel-heading">
							<h4 class="panel-title" >
								<span class="glyphicon glyphicon-list-alt"> Grupos</span>
								<span class="glyphicon glyphicon-chevron-up pull-right"></span>
							</h4>
						</div>
						<span class="glyphicon glyphicon-warning-sign"> Aún no hay grupos disponibles para instalar.</span>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-12">
					<div class="panel panel-primary">
						<div class="panel-heading">
							<h4 class="panel-title" style="height:100%;" >
								<span class="glyphicon glyphicon-list"> Programas disponibles</span>
								<span class="glyphicon glyphicon-chevron-up pull-right"></span>
							</h4>
						</div>
						<table id="table_id"  class="table table-striped table-bordered" style="table-layout:fixed"></table>
						<div class="panel-footer">
							<span class="glyphicon glyphicon-info-sign"> Seleccione los programas que desea instalar y haga click en </span>
							<button id="install" href="" onclick="this.setAttribute('href', 'ProgressDialog.html?d='+Date.now());" class="btn btn-mini btn-default " disabled data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-download-alt"></span>
								Instalar
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
	</html>