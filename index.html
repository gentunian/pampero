<!DOCTYPE html>
	<html>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<head>
		<style type="text/css" title="currentStyle">
		@import "css/demo_page.css";
		@import "css/demo_table_jui.css";
		@import "css/TableTools_JUI.css";
		@import "css/themes/smoothness-v1/smoothness-v1.css";
		@import "css/dialog.css";
		@import "css/customTableStyles.css";
		</style>
		<style>
		body {
			font-size: 12px;
			font-family: "Verdana";
		}
		</style>
		<script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/jquery.dataTables.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/TableTools.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/ZeroClipboard.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/jquery-ui-1.10.3.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/dialog.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/progressDialogTable.js"></script>
		<script>
		(function() {
			var method;
			var noop = function () {};
			var methods = [
			'assert', 'clear', 'count', 'debug', 'dir', 'dirxml', 'error',
			'exception', 'group', 'groupCollapsed', 'groupEnd', 'info', 'log',
			'markTimeline', 'profile', 'profileEnd', 'table', 'time', 'timeEnd',
			'timeStamp', 'trace', 'warn'
			];
			var length = methods.length;
			var console = (window.console = window.console || {});

			while (length--) {
				method = methods[length];

				if (!console[method]) {
					console[method] = noop;
				}
			}
		}());

		// Tries to autodetect  operating system.
		function autoDetectOS() {
			var OSName="Unknown OS";
			if ( navigator.appVersion.indexOf( "Win" )!=-1 ) OSName="Windows";
			if ( navigator.appVersion.indexOf( "Mac" )!=-1 ) OSName="MacOS";
			if ( navigator.appVersion.indexOf( "X11" )!=-1 ) OSName="UNIX";
			if ( navigator.appVersion.indexOf( "Linux" )!=-1 ) OSName="Linux";
			return OSName;
		}

		// The table used to show available programs
		//var fTable;

		// The table used to report installation. This table will be embedded in the progress dialog
		//var reportTable;

		// A dialog to display installation progress
		var dialog;

		// progressImages will contain image resources representing the state the index describes
		// * 'install_busy' index will represent a progress image that denotes installing state.
		// * 'install_ok' index will represent a progress image that denotes OK state.
		// * 'install_error' index will represent a progress image that denotes ERROR state.
		var progressImages = [];
		progressImages[ 'install_busy' ] = "images/loading.gif";
		progressImages[ 'install_ok' ] = "images/ok.png";
		progressImages[ 'install_error' ] = "images/error.png";

		// Returns a pair of (rows, url) where 'rows' is an array of rowData
		// and 'url' is the url to send to the server with selected data
		function getSelectedRows( id ) {
			var trs = getSelectedTRs( id );
			var rows = [];
			var url = "";
			for( var i = 0; i < trs.length; i++ ) {
				var rowData = $( '#table_id' ).dataTable().fnGetData( trs[i] );
				url += "id[]=" + rowData.id + "&";
				rows.push(rowData);
			}
			return { data: rows, url: url};
		}

		// Returns <tr> elements that are selected
		function getSelectedTRs( id ) {
			return $( id+" .row_selected1");
		}

		// DOM ready function
		$( document ).ready( function() {
			// Creates the DataTable
			$( '#table_id' ).dataTable({
				"bJQueryUI": true,
				"sDom": '<"H"Tfr>t<"F"lpi>',
				"oTableTools": {
					"sRowSelect": "multi",
					"aButtons": [ "select_all", "select_none" ],
					"fnRowSelected": function( nodes ) {
						$( '#submit' ).removeAttr('disabled');
					},
					"fnRowDeselected": function( nodes ) {
						if (TableTools.fnGetInstance( 'table_id' ).fnGetSelected().length == 0) {
							$( '#submit' ).attr( 'disabled', 'disabled' );
						}
					},
					"sSelectedClass": "row_selected1"
				},
				"fnServerData": function ( sSource, aoData, fnCallback ) {
					$.getJSON( sSource, aoData, function (json) { 
						fnCallback({ "aaData": json });
					} );
				},
				"bProcessing": true,
				"sAjaxSource": "php/packages.php?command=list",
				"aoColumns": [
				{ "mData": "id", "bVisible": false },
				{ "mData": "name", "sTitle": "Nombre", "sClass": "left"	},
				{ "mData": "os","sTitle": "Sistema Operativo", "sClass": "center" },
				{ "mData": "arch", "sTitle": "Arquitectura", "sClass": "center"	},
				{ "mData": "version", "sTitle": "Version", "sClass": "center" },
				{ "mData": "description", "sTitle": "Descripcion", "sClass": "left"	}
				]
			});
	        // Creates a dialog to show installation progress
	        dialog = Dialog.createProgressDialog(
	        	"#dialog-box",
	        	{ 
	        		title: "Comenzando la Instalación",
	        		message: "ATENCION: No apague el equipo ni recargue la página. "
	        		+ "Se está realizando la instalación de los paquetes seleccionados. "
	        		+ "Aguarde a que termine la instalación.",
	        		closeText: "Cerrar",
	        		ajaxSettings: {
	        			type: 'GET',
	        			dataType: 'json',
	        			url: '../php/packages.php?command=poll&target=' + $( '#hostname' ).text(),
	        			cache: false,
	        			success: function( data, status, jqXHR ) {
	        				console.log(data);
	        				var data = data[$( '#hostname' ).text()];
	        				dialog.setTitle( "Instalando " + data.current + " \t("+data.installed+"/"+data.toInstall+")" );
	        				dialog.setValue( installed );
	        			},
	        			error: function( jq, status, er){
	        				console.log(status);
	        			}
	        		}
	        	});

	        // Sets the content for the dialog
	        dialog.setContent('<table id="dialog-table" style="font-size: 11px;" class="display"></table>');

	        // Creates the datatable
	        $( '#dialog-table' ).dataTable({
				"bJQueryUI": true,
				"bSort": false,
				"bPaginate": false,
				"bFilter": false,
				"bInfo": false,
				"sScrollY": "150px",
				"bDeferRender": true,
				"bAutoWidth": false,
				"aoColumns": [
				{ "sTitle": "Aplicacion" },
				{
					"mRender": function(  data, type, full ) {
						console.log( data );
						return '<img width="24" height="24"  src="'+data+'"/>';
					},
					"sTitle": "Instalado",
					"sWidth": "24px",
					"sClass": "center"
				}
				]
			});
            // Binds the submit button
			$( '#form' ).submit( function() {
				// Gets selected data
				var rows = getSelectedRows( "#table_id" );
				dialog.max = rows.data.length;

				// Loads dialog table with data
				for(var i = 0; i < rows.data.length; i++) {
					$('#dialog-table').dataTable().fnAddData( [rows.data[i].id, progressImages['install_busy']] );
				}

				// Gets the query URL
				var url = "php/packages.php?command=install&target=" + $( '#hostname' ).text() + "&" + rows.url;

				// Builds an AJAX request
				$.ajax({
					type: 'POST',
					cache: false,
					url: url,
					beforeSend: function( jqXHR, settings ) {
						dialog.startProgressQuery();
						dialog.show();
					},
					success: function( data, status, jqXHR) {
						console.log("success: ");
						console.log(data);
						dialog.stopProgressQuery();
					},
					error: function( jq, status, er ) {
						console.log("error: "+status+" - "+er);
					},
				});
				return false;
			} );  
		})
		</script>
	</head>
	<body>
		<?php
		$hostname = (isset($_GET['hostname']))? $_GET['hostname'] : gethostname();
		echo '<div id="hostname" style="display:none;">'.$hostname.'</div>';
		?>

		<!-- A progress dialog to be shown when installation starts -->
		<div id="dialog-box"></div>

		<!-- The form the user will submit with installation data -->
		<form id="form">
			<table id="table_id" class="display"></table>
			<div style="text-align:right; padding-top:1em;">
				<button id="submit" type="submit" disabled>Instalar</button>
			</div>
		</form>
	</body>
	</html>